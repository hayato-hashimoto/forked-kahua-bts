;; -*- coding: euc-jp; mode: scheme -*-
;; test kagoiri-musume script.
;; $Id: test.scm.in,v 1.2 2005/10/10 11:59:59 cut-sea Exp $

(use gauche.test)
(use file.util)
(use text.tree)
(use sxml.ssax)
(use sxml.sxpath)
(use kahua)
(use kahua.test.xml)
(use kahua.test.worker)

(test-start "kagoiri-musume")

(define GOSH "##GOSH##")

(sys-system "rm -rf _tmp _work")
(sys-mkdir "_tmp" #o755)
(sys-mkdir "_db" #o755)
(sys-mkdir "_work" #o755)
(sys-mkdir "_work/plugins" #o755)

(for-each (lambda (f)
	    (copy-file #`"../plugins/,f" #`"_work/plugins/,f"))
	  (list "css.scm" "kagoiri-musume.scm" "sendmail.scm" "upload.scm"))

(define *config* "test.conf")
(kahua-init *config*)

(define *dbname* "_db")

(define-class <session-state-dummy> ()
  ((user :init-value #f)))

(define with-testenv
  (case-lambda
   ((thunk)
    (parameterize (kahua-current-context
		   `(("session-state" ,(make <session-state-dummy>))))
      (with-db (db *dbname*) (thunk))))
   ((login-name thunk)
    (with-testenv
     (lambda ()
       (or (kahua-user-exists? login-name)
	   (kahua-add-user login-name ""))

       ;; make user environment and set as as current user.
       (set! (kahua-current-user) login-name)
       (thunk))))))

;;------------------------------------------------------------
;; Run kagoiri-musume
(test-section "kahua-server kagoiri-musume.kahua")

(with-worker
 (w `(,GOSH "-I.." "-I##KAHUA_LIB##" "kahua-server.scm" "-c" ,*config*
            "../kagoiri-musume/kagoiri-musume.kahua"))

 (test* "run kagoiri-musume.kahua" #t (worker-running? w))

 (test* "kagoiri-musume top"
	'(html
	  (head (title ?_) (meta ?@) (link ?@))
	  (body (table
		 (tr (td (h1 ?_))
		     (td (a (@ (href ?&)) "トップ"))
		     (td (a ?@ "システム管理"))
		     (td (a ?@ "ユニット一覧"))
		     (td (a ?@ "[[login]]"))))
		(hr)
		(h2 ?_)
		(ul 
		 (li (a ?@ "システム設定管理画面"))
		 (li (a ?@ "ユニット一覧")))))
        (call-worker/gsid w '() '() (lambda (h b) (tree->string b)))
        (make-match&pick w))

 (test* "kagoiri-musume top link click"
	'(html
	  (head (title ?_) (meta ?@) (link ?@))
	  (body (table
		 (tr (td (h1 ?_))
		     (td (a ?@ "トップ"))
		     (td (a (@ (href ?&)) "システム管理"))
		     (td (a ?@ "ユニット一覧"))
		     (td (a ?@ "[[login]]"))))
		(hr)
		(h2 ?_)
		(ul 
		 (li (a ?@ "システム設定管理画面"))
		 (li (a ?@ "ユニット一覧")))))
        (call-worker/gsid w '() '() (lambda (h b) (tree->string b)))
        (make-match&pick w))
 )

(test-end)
