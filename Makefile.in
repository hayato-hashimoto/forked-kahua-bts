# Makefile for kagoiri-musume
# $Id: Makefile.in,v 1.53 2006/03/12 08:10:03 shibata Exp $

package	          = kagoiri-musume
kahua		  = kahua
SHELL             = @SHELL@
prefix            = @prefix@
exec_prefix       = @exec_prefix@
bindir            = @bindir@/$(kahua)
sbindir           = @sbindir@/$(kahua)
libexecdir	  = @libexecdir@/$(kahua)
datadir		  = @datadir@/$(kahua)
sysconfdir        = @sysconfdir@/$(kahua)
sharedstatedir    = @sharedstatedir@/$(kahua)
localstatedir     = @localstatedir@/$(kahua)
libdir            = @libdir@/$(kahua)
includedir        = @includedir@/$(kahua)
oldincludedir     = @oldincludedir@/$(kahua)
infodir           = @infodir@/$(kahua)
mandir            = @mandir@/$(kahua)
srcdir            = @srcdir@
VPATH             = $(srcdir)
top_builddir      = @top_builddir@
top_srcdir        = @top_srcdir@

DESTDIR  =

GOSH = @GOSH@
INSTALL = @INSTALL@
KAHUA_INSTALL = @KAHUA_INSTALL@
KAHUA_WORKING = $(localstatedir)
KAHUA_LIB     = $(libdir)

# specify -c ../kahua.conf etc. to give an alternative conf file
KAHUACONFIG = -c $(sysconfdir)/kahua.conf

KAGOIRI_MUSUME_INPLACE = $(shell pwd)

KAGOIRI_MUSUME_VERSION = $(shell cat $(top_srcdir)/VERSION)
KAGOIRI_MUSUME_WORKING = $(KAGOIRI_MUSUME_INPLACE)
KAGOIRI_MUSUMECONFIG = -c $(KAGOIRI_MUSUME_INPLACE)/kagoiri-musume.conf

SCRIPTS	= kagoiri-musume-start kagoiri-musume-stop

SCRIPTFILES = kagoiri-musume/kagoiri-musume.kahua \
	      kagoiri-musume/class.kahua \
	      kagoiri-musume/fan.kahua \
	      kagoiri-musume/group.kahua \
	      kagoiri-musume/search.kahua \
	      kagoiri-musume/page.kahua \
	      kagoiri-musume/parts-collection.kahua \
	      kagoiri-musume/gadget.kahua \
	      kagoiri-musume/sys-admin.kahua \
	      kagoiri-musume/hidden.kahua \
	      kagoiri-musume/util.kahua \
	      kagoiri-musume/version.kahua \
	      kagoiri-musume/debug-support.kahua \
	      kagoiri-musume/migration.kahua

LOCALSCRIPTFILES = kagoiri-musume/user-setting.kahua

STATICFILES = kagoiri-musume/kagoiri-musume.css \
	      kagoiri-musume/fixed4ie.css \
	      kagoiri-musume/images/logo.gif \
	      kagoiri-musume/images/logo-trans.gif \
	      kagoiri-musume/images/title.gif \
	      kagoiri-musume/images/title-trans.gif
JAVASCRIPTFILES = kagoiri-musume/javascripts/kagoiri-musume.js \
		  kagoiri-musume/javascripts/async.js \
		  kagoiri-musume/javascripts/prototype.js \
		  kagoiri-musume/javascripts/builder.js \
		  kagoiri-musume/javascripts/controls.js \
		  kagoiri-musume/javascripts/dragdrop.js \
		  kagoiri-musume/javascripts/effects.js \
		  kagoiri-musume/javascripts/scriptaculous.js \
		  kagoiri-musume/javascripts/slider.js \
		  kagoiri-musume/javascripts/unittest.js

SOURCEDIR   = kagoiri-musume
PLUGINDIR   = plugins
PLUGINFILES = kagoiri-musume.scm calendar.scm css.scm sendmail-with-headers.scm async.scm csv.scm
TESTFILES   = system-admin change-password \
              unit-list unit-operate \
              musume-list musume-operate \
              melody-list melody-operate


CONFIG_GENERATED = Makefile kagoiri-musume.conf test/common.scm config.log config.status autom4*.cache

.PHONY: all check clean distclean install maintainer-clean

all:	test/common.scm $(SCRIPTS) kagoiri-musume/version.kahua kagoiri-musume.conf
	-rm -rf tmp checkout
	mkdir tmp
	ln -s . checkout

kagoiri-musume-start: kagoiri-musume-start.in
	sed -e "s@###KAGOIRI_MUSUME_INPLACE###@$(KAGOIRI_MUSUME_INPLACE)@" $? > $@
	chmod +x $@

kagoiri-musume-stop: kagoiri-musume-stop.in
	sed -e "s@###KAGOIRI_MUSUME_INPLACE###@$(KAGOIRI_MUSUME_INPLACE)@" $? > $@
	chmod +x $@

test/common.scm: test/common.scm.in
	sed -e "s@##GOSH##@$(GOSH)@" -e "s@##KAHUA_WORKING##@$(KAHUA_WORKING)@" -e "s@##KAHUA_LIB##@$(KAHUA_LIB)@" -e "s@##KAGOIRI_MUSUME_VERSION##@$(KAGOIRI_MUSUME_VERSION)@" -e "s@##PLUGINS##@$(PLUGINFILES)@" $? > $@

kagoiri-musume/version.kahua: kagoiri-musume/version.kahua.in
	sed -e "s@###KAGOIRI_MUSUME_VERSION###@$(KAGOIRI_MUSUME_VERSION)@" $? > $@

kagoiri-musume.conf: kagoiri-musume.conf.in
	sed -e "s@###KAGOIRI_MUSUME_INPLACE_SOCKETBASE###@$(KAGOIRI_MUSUME_INPLACE)/tmp@" -e "s@###KAGOIRI_MUSUME_INPLACE_WORKING###@$(KAGOIRI_MUSUME_INPLACE)@" -e "s@###KAGOIRI_MUSUME_INPLACE_DOCPATH###@$(KAGOIRI_MUSUME_INPLACE)@" $? > $@

check:  all
	rm -f test/test.log
	cd test; \
	for f in $(TESTFILES); do \
	  $(GOSH) -I. -I$(KAHUA_LIB) ./$$f.scm > $$f.log; \
	done

clean:
	rm -rf core *~ kagoiri-musume/*~ kagoiri-musume/version.kahua test/*~ test/common.scm $(SCRIPTS) checkout

dbinit:
	$(GOSH) -I$(KAHUA_LIB) -I./ -l kagoiri-musume/user-setting.kahua initdb.scm;

install: dbinit
	$(KAHUA_INSTALL) $(KAHUACONFIG) -t script $(SCRIPTFILES)
	$(KAHUA_INSTALL) $(KAHUACONFIG) -t script --no-overwrite $(LOCALSCRIPTFILES)
	$(KAHUA_INSTALL) $(KAHUACONFIG) -t static $(STATICFILES)
	$(KAHUA_INSTALL) $(KAHUACONFIG) -t static $(JAVASCRIPTFILES)
	for f in $(PLUGINFILES); do \
	  $(KAHUA_INSTALL) $(KAHUACONFIG) -t plugin -r $$f $(PLUGINDIR)/$$f;\
	done

	for f in $(SCRIPTS); do \
	  $(INSTALL) -m 555 $$f $(bindir)/$$f;\
	done

uninstall :
	$(KAHUA_INSTALL) -U $(KAHUACONFIG) -t script $(SCRIPTFILES)
	$(KAHUA_INSTALL) -U $(KAHUACONFIG) -t static $(STATICFILES)
	$(KAHUA_INSTALL) -U $(KAHUACONFIG) -t static $(JAVASCRIPTFILES)
	for f in $(PLUGINFILES); do \
		$(KAHUA_INSTALL) $(KAHUACONFIG) -t plugin -r $$f $(PLUGINDIR)/$$f;\
	done

distclean: clean
	-rm -rf $(CONFIG_GENERATED)

maintainer-clean: clean
	-rm -rf $(CONFIG_GENERATED) configure VERSION DIST_EXCLUDE_X
